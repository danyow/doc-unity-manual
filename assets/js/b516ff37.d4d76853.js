"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[19730],{3905:function(t,e,a){a.d(e,{Zo:function(){return m},kt:function(){return p}});var l=a(67294);function o(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}function r(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(t);e&&(l=l.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.push.apply(a,l)}return a}function n(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?r(Object(a),!0).forEach((function(e){o(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}function i(t,e){if(null==t)return{};var a,l,o=function(t,e){if(null==t)return{};var a,l,o={},r=Object.keys(t);for(l=0;l<r.length;l++)a=r[l],e.indexOf(a)>=0||(o[a]=t[a]);return o}(t,e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);for(l=0;l<r.length;l++)a=r[l],e.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(t,a)&&(o[a]=t[a])}return o}var s=l.createContext({}),c=function(t){var e=l.useContext(s),a=e;return t&&(a="function"==typeof t?t(e):n(n({},e),t)),a},m=function(t){var e=c(t.components);return l.createElement(s.Provider,{value:e},t.children)},u={inlineCode:"code",wrapper:function(t){var e=t.children;return l.createElement(l.Fragment,{},e)}},d=l.forwardRef((function(t,e){var a=t.components,o=t.mdxType,r=t.originalType,s=t.parentName,m=i(t,["components","mdxType","originalType","parentName"]),d=c(a),p=o,k=d["".concat(s,".").concat(p)]||d[p]||u[p]||r;return a?l.createElement(k,n(n({ref:e},m),{},{components:a})):l.createElement(k,n({ref:e},m))}));function p(t,e){var a=arguments,o=e&&e.mdxType;if("string"==typeof t||o){var r=a.length,n=new Array(r);n[0]=d;var i={};for(var s in e)hasOwnProperty.call(e,s)&&(i[s]=e[s]);i.originalType=t,i.mdxType="string"==typeof t?t:o,n[1]=i;for(var c=2;c<r;c++)n[c]=a[c];return l.createElement.apply(null,n)}return l.createElement.apply(null,a)}d.displayName="MDXCreateElement"},40302:function(t,e,a){a.r(e),a.d(e,{assets:function(){return m},contentTitle:function(){return s},default:function(){return p},frontMatter:function(){return i},metadata:function(){return c},toc:function(){return u}});var l=a(87462),o=a(63366),r=(a(67294),a(3905)),n=["components"],i={id:"memory-allocator-customization",title:"Memory allocator customization",slug:"/performance-memory-overview/memory-allocator-customization"},s="Memory allocator customization",c={unversionedId:"unity-overview/analysis/performance-memory-overview/memory-allocator-customization",id:"unity-overview/analysis/performance-memory-overview/memory-allocator-customization",title:"Memory allocator customization",description:"When you are optimizing your application\u2019s performance, one important factor to consider is the allocation of memory. This documentation provides information on Unity\u2019s native memory allocator types, and describes scenarios where you can customize the allocators to improve performance. It is intended for users with a general understanding of allocators.",source:"@site/docs/unity-overview/analysis/performance-memory-overview/memory-allocator-customization.md",sourceDirName:"unity-overview/analysis/performance-memory-overview",slug:"/performance-memory-overview/memory-allocator-customization",permalink:"/doc-unity-manual/docs/performance-memory-overview/memory-allocator-customization",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/unity-overview/analysis/performance-memory-overview/memory-allocator-customization.md",tags:[],version:"current",frontMatter:{id:"memory-allocator-customization",title:"Memory allocator customization",slug:"/performance-memory-overview/memory-allocator-customization"},sidebar:"tutorialSidebar",previous:{title:"Memory in Unity",permalink:"/doc-unity-manual/docs/performance-memory-overview"},next:{title:"Garbage collector overview",permalink:"/doc-unity-manual/docs/performance-garbage-collector"}},m={},u=[{value:"Dynamic heap, bucket, and dual thread allocators",id:"dynamic-heap-bucket-and-dual-thread-allocators",level:2},{value:"\u6982\u8ff0",id:"\u6982\u8ff0",level:3},{value:"Dynamic heap allocator",id:"dynamic-heap-allocator",level:3},{value:"Bucket allocator",id:"bucket-allocator",level:3},{value:"Dual thread allocator",id:"dual-thread-allocator",level:3},{value:"TLS and threadsafe linear allocators",id:"tls-and-threadsafe-linear-allocators",level:2},{value:"\u6982\u8ff0",id:"\u6982\u8ff0-1",level:3},{value:"Thread Local Storage (TLS) stack allocator",id:"thread-local-storage-tls-stack-allocator",level:3},{value:"Threadsafe linear allocator",id:"threadsafe-linear-allocator",level:3},{value:"Customizing allocators",id:"customizing-allocators",level:2},{value:"Storing and reading the settings",id:"storing-and-reading-the-settings",level:2}],d={toc:u};function p(t){var e=t.components,a=(0,o.Z)(t,n);return(0,r.kt)("wrapper",(0,l.Z)({},d,a,{components:e,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"memory-allocator-customization"},"Memory allocator customization"),(0,r.kt)("p",null,"When you are optimizing your application\u2019s performance, one important factor to consider is the allocation of memory. This documentation provides information on Unity\u2019s native memory allocator types, and describes scenarios where you can customize the allocators to improve performance. It is intended for users with a general understanding of allocators."),(0,r.kt)("p",null,"For a full reference of allocator types and their default values, see ",(0,r.kt)("a",{parentName:"p",href:"#which-you-can-customize"},"Customizing allocators"),"."),(0,r.kt)("p",null,"An application uses memory allocators to balance performance and available memory space. If an application has a lot of spare memory, it can favour faster, memory-heavy allocators when it loads scenes and frames. However, if the application has limited memory, it needs to use that memory efficiently, even if that means using slower allocators. To help you get the best performance for different projects, you can customize Unity\u2019s allocators to fit the size and requirements of each application."),(0,r.kt)("p",null,"Unity has five allocator types. Each type has a different algorithm for fitting allocations into blocks of memory, and is therefore useful for different allocations. The important difference between allocations is usually persistence, or allocation lifespan, which determines where an allocation should go. For example, a long-live (persistent) allocation goes to the heap and bucket allocators, while short-lived allocations go to the threadsafe linear and TLS allocators."),(0,r.kt)("p",null,"This table lists the algorithm and uses of each allocator type:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"Allocator type")),(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"Algorithm")),(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"Used for")))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Dynamic heap"),(0,r.kt)("td",{parentName:"tr",align:null},"Two Level Segregated Fit (TLSF)"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2022 Main allocator",(0,r.kt)("br",null),"\u2022 Gfx allocator",(0,r.kt)("br",null),"\u2022 Typetree allocator",(0,r.kt)("br",null),"\u2022 File cache allocator",(0,r.kt)("br",null),"\u2022 Profiler allocator",(0,r.kt)("br",null),"\u2022 Editor Profiler allocator (on Editor only)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Bucket"),(0,r.kt)("td",{parentName:"tr",align:null},"Fixed size lock-free allocator"),(0,r.kt)("td",{parentName:"tr",align:null},"As a shared allocator for small allocations for:",(0,r.kt)("br",null),(0,r.kt)("br",null),"\u2022 Main allocator",(0,r.kt)("br",null),"\u2022 Gfx allocator",(0,r.kt)("br",null),"\u2022 Typetree allocator",(0,r.kt)("br",null),"\u2022 File cache allocator")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Dual thread"),(0,r.kt)("td",{parentName:"tr",align:null},"Redirects allocations based on size and thread ID"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2022 Main allocator",(0,r.kt)("br",null),"\u2022 Gfx allocator",(0,r.kt)("br",null),"\u2022 Typetree allocator",(0,r.kt)("br",null),"\u2022 File cache allocator")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Thread Local Storage (TLS) stack"),(0,r.kt)("td",{parentName:"tr",align:null},"LIFO stack"),(0,r.kt)("td",{parentName:"tr",align:null},"Temporary allocations")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Threadsafe linear"),(0,r.kt)("td",{parentName:"tr",align:null},"Round robin FIFO"),(0,r.kt)("td",{parentName:"tr",align:null},"Buffers for passing data to jobs")))),(0,r.kt)("p",null," ",(0,r.kt)("strong",{parentName:"p"},"Note")," : The examples in this documentation use the memory usage reports that are written to the log when you close the player or Editor. To find your log files, follow the instructions on ",(0,r.kt)("a",{parentName:"p",href:"/doc-unity-manual/docs/analysis/log-files"},"the log files page"),"."),(0,r.kt)("h2",{id:"dynamic-heap-bucket-and-dual-thread-allocators"},"Dynamic heap, bucket, and dual thread allocators"),(0,r.kt)("p",null,"This section reviews the functionality and customization scenarios for the dynamic heap, bucket and dual thread allocators."),(0,r.kt)("h3",{id:"\u6982\u8ff0"},"\u6982\u8ff0"),(0,r.kt)("p",null,"The  ",(0,r.kt)("strong",{parentName:"p"},"dual thread allocator"),"  is a wrapper that combines  ",(0,r.kt)("strong",{parentName:"p"},"dynamic"),"  and  ",(0,r.kt)("strong",{parentName:"p"},"bucket"),"  allocators. More specifically, it combines:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Two dynamic heap allocators: A lock-free allocator for the main thread, and an allocator that is shared by all other threads, which locks on allocation and deallocation. Unity uses these allocators for allocations that are too large for the bucket allocator. The dynamic heap allocator uses memory blocks. Allocations that are equal to or greater than half a block go to the virtual memory system instead of the dynamic heap allocator."),(0,r.kt)("li",{parentName:"ul"},"A bucket allocator for small allocations. If the bucket allocator is full, allocation spills over into the dynamic heap allocator.")),(0,r.kt)("h3",{id:"dynamic-heap-allocator"},"Dynamic heap allocator"),(0,r.kt)("p",null,"The main heap allocator is the dynamic heap allocator. It applies the algorithm Two Level Segregated Fit (TLSF) to blocks of memory."),(0,r.kt)("p",null,"Each platform has a default block size, ",(0,r.kt)("a",{parentName:"p",href:"#which-you-can-customize"},"which you can customize"),". An allocation must be smaller than half a block. If an allocation is equal to or greater than half a block, it is too large for the dynamic heap allocator; instead, Unity uses the virtual memory API to make the allocation."),(0,r.kt)("p",null,"An example usage report for the dynamic heap allocator:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[ALLOC_DEFAULT_MAIN]\nPeak usage frame count: [16.0 MB-32.0 MB]: 497 frames, [32.0 MB-64.0 MB]: 1 frames\nRequested Block Size 16.0 MB\nPeak Block count 2\nPeak Allocated memory 54.2 MB\nPeak Large allocation bytes 40.2 MB\n")),(0,r.kt)("p",null,"In this example, the TLSF block size is set to 16 MB, and Unity has allocated two blocks. The peak usage of the allocator was 54.2MB. Of those 52.4MB, 40.2MB were not allocated in the TLSF block, and instead fell back to virtual memory. Most frames had 16\u201332MB of allocated memory, while one frame - likely the loading frame - peaked at 32\u201364MB of memory."),(0,r.kt)("p",null,"If you increased the block size the large allocation would stay in the dynamic heap rather than fall back into virtual memory. However, that block size could lead to memory waste, because the blocks might not be fully used."),(0,r.kt)("p",null,"To avoid using the typetree and cache allocators, set their size to 0. Allocations that would have used typetree and cache will instead fall back to the main allocator. This can cause more fragmentation, but saves the memory of those allocators\u2019 memory blocks."),(0,r.kt)("h3",{id:"bucket-allocator"},"Bucket allocator"),(0,r.kt)("p",null,"The bucket allocator is a fast lock-free allocator that performs small allocations. Usually, the bucket allocator is used as a first step to speed up small allocations, before they go to the heap allocator."),(0,r.kt)("p",null,"The allocator reserves blocks of memory for allocations. Each block is divided into  ",(0,r.kt)("strong",{parentName:"p"},"subsections"),"  of 16KB. This is not configurable, and does not appear in the user interface. Each subsection is divided into  ",(0,r.kt)("strong",{parentName:"p"},"allocations")," . The allocation size is a multiple of a configured fixed size, called  ",(0,r.kt)("strong",{parentName:"p"},"granularity")," ."),(0,r.kt)("p",null,"The following example setup demonstrates the process of reserving blocks for allocations:"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://docs.unity3d.com/cn/2022.1/uploads/Main/Shared_Bucket.png",alt:"Shared Bucket Allocator for the Windows, Mac and Linux player"})),(0,r.kt)("p",null,"Shared Bucket Allocator for the Windows, Mac and Linux player"),(0,r.kt)("p",null,"In this setup, the total  ",(0,r.kt)("strong",{parentName:"p"},"block"),"  size ( ",(0,r.kt)("strong",{parentName:"p"},"Bucket Allocator Block Size")," ) is 4MB, and the granularity of allocations ( ",(0,r.kt)("strong",{parentName:"p"},"Bucket Allocator Granularity")," ) is 16B. The first allocation is 16B, the second is 32B (2","*","16), then 48B, 64B, 80B, 96B, 112B, and 128B, for a total of eight buckets ( ",(0,r.kt)("strong",{parentName:"p"},"Bucket Allocator BucketCount")," )."),(0,r.kt)("p",null,"Each subsection contains a different number of buckets. To calculate the number of buckets in a subsection, divide the subsection size (16KB) by the granularity size. For example:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"When the allocation granularity is 64B, 256 buckets fit in a subsection."),(0,r.kt)("li",{parentName:"ul"},"When the allocation granularity is 16B, 1,024 buckets fit in a subsection.")),(0,r.kt)("p",null,"Bucket allocators produce different usage reports for a development build and a release build, because a development build, each allocation has a header of an additional 40B. The following diagram demonstrates the difference between development and release builds for 16B and 64B allocations:"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://docs.unity3d.com/cn/2022.1/uploads/Main/memory_allocation.png",alt:"Development and Release builds comparison"})),(0,r.kt)("p",null,"Development and Release builds comparison"),(0,r.kt)("p",null,"The header is also the reason the allocator reports it is full after allocating only 2MB of its 4MB:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[ALLOC_BUCKET]\n      Large Block size 4.0 MB\n      Used Block count 1\n      Peak Allocated bytes 2.0 MB\n      Failed Allocations. Bucket layout:\n        16B: 64 Subsections = 18724 buckets. Failed count: 3889\n        32B: 17 Subsections = 3868 buckets. Failed count: 169583\n        48B: 31 Subsections = 5771 buckets. Failed count: 39674\n        64B: 28 Subsections = 4411 buckets. Failed count: 9981\n        80B: 17 Subsections = 2321 buckets. Failed count: 14299\n        96B: 6 Subsections = 722 buckets. Failed count: 9384\n        112B: 44 Subsections = 4742 buckets. Failed count: 5909\n        128B: 49 Subsections = 4778 buckets. Failed count: 8715\n")),(0,r.kt)("p",null,"In a release build for the same project, the allocator block size is enough:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[ALLOC_BUCKET]\n      Large Block size 4.0 MB\n      Used Block count 1\n      Peak Allocated bytes 3.3 MB\n")),(0,r.kt)("p",null,"If the bucket allocator is full, the allocation falls back to another allocator. The usage report displays usage statistics, including how many allocations failed. If the report displays a fail count that increases linearly, it is likely that the failed allocations happen when calculating the frames, not the load. Fallback allocations are not a problem for a scene load, but they can impact performance if they happen when calculating frames."),(0,r.kt)("p",null,"To prevent these fallback allocations, increase the block size, and limit the new block size to match the frames\u2019 peak usage, rather than the scene load peak usage. This prevents the block from becoming so large that it reserves a lot of memory that is then not available at runtime."),(0,r.kt)("p",null," ",(0,r.kt)("strong",{parentName:"p"},"Tip")," : The Profiler allocators share an instance of a bucket allocator. You can customize this shared instance in the ",(0,r.kt)("a",{parentName:"p",href:"#shared-profiler-bucket-allocator"},"Shared Profiler Bucket Allocator"),"."),(0,r.kt)("h3",{id:"dual-thread-allocator"},"Dual thread allocator"),(0,r.kt)("p",null,"The dual thread allocator wraps a shared bucket allocator for small allocations, and two instances of the dynamic heap allocator: a lock-free allocator for the main thread, and an allocator that is shared by all other threads, but locks on allocation and deallocation."),(0,r.kt)("p",null,"You can customize the block sizes of the two dynamic heap allocators:"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://docs.unity3d.com/cn/2022.1/uploads/Main/Main_Allocator.png",alt:"Main Allocator, with a custom value for Shared Thread Block Size"})),(0,r.kt)("p",null,"Main Allocator, with a custom value for Shared Thread Block Size"),(0,r.kt)("p",null,"The usage report contains information for all three parts of the allocator. For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[ALLOC_DEFAULT] Dual Thread Allocator\n  Peak main deferred allocation count 135\n    [ALLOC_BUCKET]\n      Large Block size 4.0 MB\n      Used Block count 1\n      Peak Allocated bytes 3.3 MB\n    [ALLOC_DEFAULT_MAIN]\n      Peak usage frame count: [16.0 MB-32.0 MB]: 8283 frames, [32.0 MB-64.0 MB]: 1 frames\n      Requested Block Size 16.0 MB\n      Peak Block count 2\n      Peak Allocated memory 53.3 MB\n      Peak Large allocation bytes 40.2 MB\n    [ALLOC_DEFAULT_THREAD]\n      Peak usage frame count: [64.0 MB-128.0 MB]: 8284 frames\n      Requested Block Size 16.0 MB\n      Peak Block count 2\n      Peak Allocated memory 78.3 MB\n      Peak Large allocation bytes 47.3 MB\n")),(0,r.kt)("p",null," ",(0,r.kt)("strong",{parentName:"p"},"Note")," : The  ",(0,r.kt)("strong",{parentName:"p"},"Peak main deferred allocation count"),"  is the number of items in a deletion queue. The main thread must delete any allocation it made. If another thread deletes an allocation, that allocation is added to a queue. The allocation waits in the queue for the main thread to delete it. It is then counted as a deferred allocation."),(0,r.kt)("h2",{id:"tls-and-threadsafe-linear-allocators"},"TLS and threadsafe linear allocators"),(0,r.kt)("p",null,"This section describes the functionality and customization scenarios for the Thread Local Storage (TLS) and threadsafe linear allocators."),(0,r.kt)("h3",{id:"\u6982\u8ff0-1"},"\u6982\u8ff0"),(0,r.kt)("p",null,"Unity has two allocators that work outside the dual thread allocator:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Thread Local Storage (TLS): A stack-based allocator for fast temporary allocations. This is the fastest allocator because it has almost no overhead. It also prevents fragmentation. It is Last In, First Out (LIFO)-based."),(0,r.kt)("li",{parentName:"ul"},"Threadsafe linear: A First In, First Out (FIFO) round-robin allocator that the temporary job allocation uses to pass short-lived memory between worker threads).")),(0,r.kt)("h3",{id:"thread-local-storage-tls-stack-allocator"},"Thread Local Storage (TLS) stack allocator"),(0,r.kt)("p",null,"Each thread uses its own fast stack allocator for temporary allocations. These allocations are very fast, with a lifespan of less than a frame."),(0,r.kt)("p",null,"The default block size for the temporary allocator is 4MB for the platforms and 16MB for the Unity Editor. You can customize these values."),(0,r.kt)("p",null," ",(0,r.kt)("strong",{parentName:"p"},"Note")," : If the allocator use exceeds the configured block size, Unity increases the block size. The limit for this increase is twice the original size."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://docs.unity3d.com/cn/2022.1/uploads/Main/Per_Thread.png",alt:"Main Thread Block Size custom value in the Fast Per Thread Temporary Allocators"})),(0,r.kt)("p",null,"Main Thread Block Size custom value in the Fast Per Thread Temporary Allocators"),(0,r.kt)("p",null,"If a thread\u2019s stack allocator is full, allocations fall back to the ",(0,r.kt)("a",{parentName:"p",href:"#threadsafe-linear-job-allocator"},"threadsafe linear job allocator"),". A few overflow allocations are fine: 1 to 10 in a frame, or a few hundred during load. However, if the numbers grow on every frame, you can increase the block sizes."),(0,r.kt)("p",null,"The information in the usage report can help you select a block size that is appropriate for your application. For example, in the following main thread usage report, the load peaks at 2.7MB, but the remaining frames are below 64KB. You can reduce the block size from 4MB to 64KB and allow the loading frame to spill over the allocations:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[ALLOC_TEMP_TLS] TLS Allocator\n  StackAllocators :\n    [ALLOC_TEMP_MAIN]\n      Peak usage frame count: [16.0 KB-32.0 KB]: 802 frames, [32.0 KB-64.0 KB]: 424 frames, [2.0 MB-4.0 MB]: 1 frames\n      Initial Block Size 4.0 MB\n      Current Block Size 4.0 MB\n      Peak Allocated Bytes 2.7 MB\n      Overflow Count 0\n    [ALLOC_TEMP_Job.Worker 18]\n")),(0,r.kt)("p",null,"In this second example, the worker thread is not used for large temporary allocations. To save memory, you can reduce the worker\u2019s block size to 32KB. This is especially useful on a multi-core machine, where each worker thread has its own stack:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[ALLOC_TEMP_Job.Worker 14]\n      Initial Block Size 256.0 KB\n      Current Block Size 256.0 KB\n      Peak Allocated Bytes 18.6 KB\n      Overflow Count 0\n")),(0,r.kt)("h3",{id:"threadsafe-linear-allocator"},"Threadsafe linear allocator"),(0,r.kt)("p",null,"The worker threads in Unity use a round robin first-in-first-out (FIFO) algorithm for fast, lock-free allocations of work buffers for jobs. The jobs dispose of the buffers when done."),(0,r.kt)("p",null,"This allocator allocates blocks of memory, then linearly allocates memory within those blocks. Available blocks are held in a pool. When one block is full, the allocator fetches a new block from the pool. When the allocator no longer needs the memory in a block, it clears the block, and the block returns to the pool of available blocks. It is important to clear allocations quickly to make blocks available again, so a job should not stay allocated for more than a few frames."),(0,r.kt)("p",null,"You can customize the block size. The allocator allocates up to 64 blocks, as needed."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://docs.unity3d.com/cn/2022.1/uploads/Main/Fast_Thread.png",alt:"Default value for Fast Thread Shared Temporary Allocators for the Editor"})),(0,r.kt)("p",null,"Default value for Fast Thread Shared Temporary Allocators for the Editor"),(0,r.kt)("p",null,"If all blocks are in use, or an allocation is too big for a block, the allocation falls back to the main heap allocator, which is much slower than the job allocator. A few overflow allocations are fine: 1 to 10 in a frame, or a few hundred, especially during load. If the overflow count grows with every frame, you can increase the block size to avoid fallback allocations. However, if you increase the block size too much (for example, to match peak use in events such as scene loading), you might leave a lot of memory unavailable during play."),(0,r.kt)("p",null,"\u4f8b\u5982\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[ALLOC_TEMP_JOB_4_FRAMES (JobTemp)]\n  Initial Block Size 0.5 MB\n  Used Block Count 64\n  Overflow Count (too large) 0\n  Overflow Count (full) 50408\n")),(0,r.kt)("p",null,"In this example usage report, the 0.5MB block size was too small to accommodate the job memory that the application needed, and the full allocator caused a large number of allocations to overflow."),(0,r.kt)("p",null,"To check whether your build\u2019s frame overflow is sufficient, run it for a short time and then for a longer time. If the overflow count remains steady, the overflow is a high watermark that occurs during load. If the overflow count increases with a longer run, the build is processing a per-frame overflow. In both cases, you can increase the blocksize to reduce the overflow, but the overflow is less critical during load than per frame."),(0,r.kt)("h2",{id:"customizing-allocators"},"Customizing allocators"),(0,r.kt)("p",null,"To customize allocator settings, do one of the following:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Use the Editor:",(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"Select ",(0,r.kt)("em",{parentName:"li"},"Project Settings")," ",">"," ",(0,r.kt)("em",{parentName:"li"},"Memory Settings"),"."),(0,r.kt)("li",{parentName:"ol"},"Select the lock icon next to the value you want to edit.")))),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://docs.unity3d.com/cn/2022.1/uploads/Main/Memory_Settings.png",alt:"Project Settings > Memory Settings, showing a selection of Player memory settings"})),(0,r.kt)("p",null,"Project Settings ",">"," Memory Settings, showing a selection of Player memory settings"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Use command line arguments. To find the name of the allocator parameters you want to change, check the list of allocator settings the Editor and players print when they start up. For example, to change the block size of the main heap allocators, use ",(0,r.kt)("inlineCode",{parentName:"li"},"-memorysetup-main-allocator-block-size=&lt;new_value&gt;"))),(0,r.kt)("p",null,"The allocator parameter names and their default values:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"Allocator")),(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"\u63cf\u8ff0")),(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"Parameter name")),(0,r.kt)("th",{parentName:"tr",align:null},(0,r.kt)("strong",{parentName:"th"},"Default value")))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Main Allocators"),(0,r.kt)("td",{parentName:"tr",align:null},"The allocators Unity uses for most allocations."),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"-> Main Allocator"),(0,r.kt)("td",{parentName:"tr",align:null},"The primary allocator Unity uses for most allocations."),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"->"),(0,r.kt)("td",{parentName:"tr",align:null},"Main Thread Block Size"),(0,r.kt)("td",{parentName:"tr",align:null},"Block size of dedicated main thread allocator."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-main-allocator-block-size"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"->"),(0,r.kt)("td",{parentName:"tr",align:null},"Shared Thread Block Size"),(0,r.kt)("td",{parentName:"tr",align:null},"Block size of shared thread allocator."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-thread-allocator-block-size"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"-> Gfx Allocator"),(0,r.kt)("td",{parentName:"tr",align:null},"The allocator Unity uses for CPU allocations related to the Gfx system."),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"->"),(0,r.kt)("td",{parentName:"tr",align:null},"Main Thread Block Size"),(0,r.kt)("td",{parentName:"tr",align:null},"Block size of the dedicated main thread Gfx allocator."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-gfx-main-allocator-block-size"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"->"),(0,r.kt)("td",{parentName:"tr",align:null},"Shared Thread Block Size"),(0,r.kt)("td",{parentName:"tr",align:null},"Block size of the shared thread Gfx allocator."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-gfx-thread-allocator-block-size"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"-> Other Allocators"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"->"),(0,r.kt)("td",{parentName:"tr",align:null},"File Cache Block Size"),(0,r.kt)("td",{parentName:"tr",align:null},"The file cache has its own allocator to avoid fragmentation. This is its block size."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-cache-allocator-block-size"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"->"),(0,r.kt)("td",{parentName:"tr",align:null},"Type Tree Block Size"),(0,r.kt)("td",{parentName:"tr",align:null},"The type treess have their own allocator to avoid fragmentation due to many small allocations. This is its block size."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-typetree-allocator-block-size"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"-> Shared Bucket Allocator"),(0,r.kt)("td",{parentName:"tr",align:null},"The bucket allocator that is shared between the main allocators."),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"->"),(0,r.kt)("td",{parentName:"tr",align:null},"Bucket Allocator Granularity"),(0,r.kt)("td",{parentName:"tr",align:null},"Step size for buckets in the shared allocator."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-bucket-allocator-granularity"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"->"),(0,r.kt)("td",{parentName:"tr",align:null},"Bucket Allocator BucketCount"),(0,r.kt)("td",{parentName:"tr",align:null},"Number of bucket sizes."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-bucket-allocator-bucket-count"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"->"),(0,r.kt)("td",{parentName:"tr",align:null},"Bucket Allocator Block Size"),(0,r.kt)("td",{parentName:"tr",align:null},"Size of memory blocks used for buckets."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-bucket-allocator-block-size"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"->"),(0,r.kt)("td",{parentName:"tr",align:null},"Bucket Allocator Block Count"),(0,r.kt)("td",{parentName:"tr",align:null},"Maximum number of blocks to be allocated."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-bucket-allocator-block-count"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Fast Per Thread Temporary Allocators"),(0,r.kt)("td",{parentName:"tr",align:null},"The Thread Local Storage (TLS) allocator that handles very short-lived allocations."),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"-> Main Thread Block Size"),(0,r.kt)("td",{parentName:"tr",align:null},"The initial size for the main thread stack."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-temp-allocator-size-main")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"Editor: 16777216"),(0,r.kt)("br",null),(0,r.kt)("inlineCode",{parentName:"td"},"Player: 4194304"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"-> Job Worker Block Size"),(0,r.kt)("td",{parentName:"tr",align:null},"Size of each job worker in the Unity job system."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-temp-allocator-size-job-worker")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"E262144"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"-> Background Job Worker Block Size"),(0,r.kt)("td",{parentName:"tr",align:null},"Size for each background worker."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-temp-allocator-size-background-worker")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"32768"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"-> Preload Block Size"),(0,r.kt)("td",{parentName:"tr",align:null},"The preload manager stack size."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-temp-allocator-size-preload-manager")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"Editor: 33554432"),(0,r.kt)("br",null),(0,r.kt)("inlineCode",{parentName:"td"},"Player: 262144"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"-> Audio Worker Block Size"),(0,r.kt)("td",{parentName:"tr",align:null},"Each audio worker thread\u2019s stack size."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-temp-allocator-size-audio-worker")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"65536"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"-> Cloud Worker Block Size"),(0,r.kt)("td",{parentName:"tr",align:null},"Cloud worker threads stack size."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-temp-allocator-size-cloud-worker")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"32768"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"-> Gfx Thread Blocksize"),(0,r.kt)("td",{parentName:"tr",align:null},"The main render threads stack size."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-temp-allocator-size-gfx")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"262144"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"-> GI Baking Blocksize"),(0,r.kt)("td",{parentName:"tr",align:null},"Each GI worker thread\u2019s stack size."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-temp-allocator-size-gi-baking-worker")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"262144"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"-> NavMesh Worker Block Size"),(0,r.kt)("td",{parentName:"tr",align:null},"Nav mesh worker threads stack size."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-temp-allocator-size-nav-mesh-worker")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"65536"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Fast Thread Shared Temporary Allocators"),(0,r.kt)("td",{parentName:"tr",align:null},"Fast linear allocator for short lived allocations shared between threads."),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"-> Job Allocator Block Size"),(0,r.kt)("td",{parentName:"tr",align:null},"The round robin linear thread allocator Unity mainly uses for the job worker threads."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-job-temp-allocator-block-size")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"2097152"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"-> Background Job Allocator Block Size"),(0,r.kt)("td",{parentName:"tr",align:null},"The linear allocator for the background workers that allows longer lived allocations."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-job-temp-allocator-block-size-background")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"21048576"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"-> Job Allocator Block Size on low memory platforms"),(0,r.kt)("td",{parentName:"tr",align:null},"Platforms with less than 2GB memory use this size for both the job workers and the background jobs."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-job-temp-allocator-reduction-small-platforms")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"262144"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Profiler Allocators"),(0,r.kt)("td",{parentName:"tr",align:null},"Allocators that Unity uses exclusively for the Profiler so that they don\u2019t interfere with the application\u2019s allocation patterns."),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"-> Profiler Block Size"),(0,r.kt)("td",{parentName:"tr",align:null},"The block size for the main part of the Profiler."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-profiler-allocator-block-size")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"16777216"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"-> Editor Profiler Block Size"),(0,r.kt)("td",{parentName:"tr",align:null},"Block size for the Editor part of the Profiler. This is not present on players."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-profiler-editor-allocator-block-size")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"1048576"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"-> Shared Profiler Bucket Allocator"),(0,r.kt)("td",{parentName:"tr",align:null},"Shared bucket allocator for the Profiler and Editor Profiler allocators.",(0,r.kt)("br",null),(0,r.kt)("br",null),"Not present on low memory platforms."),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"->"),(0,r.kt)("td",{parentName:"tr",align:null},"Bucket Allocator Granularity"),(0,r.kt)("td",{parentName:"tr",align:null},"Step size for buckets in the shared allocator."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-profiler-bucket-allocator-granularity"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"->"),(0,r.kt)("td",{parentName:"tr",align:null},"Bucket Allocator BucketCount"),(0,r.kt)("td",{parentName:"tr",align:null},"Number of bucket sizes. For example, if the value is 4, the sizes are 16, 32, 48 and 64."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-profiler-bucket-allocator-bucket-count"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"->"),(0,r.kt)("td",{parentName:"tr",align:null},"Bucket Allocator Block Size"),(0,r.kt)("td",{parentName:"tr",align:null},"Size of memory blocks used for buckets."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-profiler-bucket-allocator-block-size"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"->"),(0,r.kt)("td",{parentName:"tr",align:null},"Bucket Allocator Block Count"),(0,r.kt)("td",{parentName:"tr",align:null},"Maximum number of blocks to be allocated."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"memorysetup-profiler-bucket-allocator-block-count"))))),(0,r.kt)("p",null," ",(0,r.kt)("strong",{parentName:"p"},"Tip")," : To ensure your settings improve performance, profile the application before and after making changes. See the ",(0,r.kt)("a",{parentName:"p",href:"/doc-unity-manual/docs/profiler"},"Profiler overview page")," for more information. You can also check the memory usage reports. They are available in the log when you close the player or Editor. To find your log files, follow the instructions on the ",(0,r.kt)("a",{parentName:"p",href:"/doc-unity-manual/docs/analysis/log-files"},"log files page"),"."),(0,r.kt)("h2",{id:"storing-and-reading-the-settings"},"Storing and reading the settings"),(0,r.kt)("p",null,"Unity stores allocator settings in ",(0,r.kt)("inlineCode",{parentName:"p"},"MemorySettings.asset"),", which populates the ",(0,r.kt)("inlineCode",{parentName:"p"},"boot.config")," file with the modified settings at build time. This means new settings take effect at every build."),(0,r.kt)("p",null,"In the Editor, the ",(0,r.kt)("inlineCode",{parentName:"p"},"boot.config")," is in the ",(0,r.kt)("inlineCode",{parentName:"p"},"ProjectSettings")," folder. It gets updated every time Unity imports or changes ",(0,r.kt)("inlineCode",{parentName:"p"},"MemorySettings.asset"),". New values for the Editor only take effect on the next Editor startup."))}p.isMDXComponent=!0}}]);