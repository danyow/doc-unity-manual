"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[19561],{3905:function(e,t,n){n.d(t,{Zo:function(){return s},kt:function(){return d}});var r=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var c=r.createContext({}),p=function(e){var t=r.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},s=function(e){var t=p(e.components);return r.createElement(c.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,i=e.mdxType,a=e.originalType,c=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),m=p(n),d=i,g=m["".concat(c,".").concat(d)]||m[d]||u[d]||a;return n?r.createElement(g,o(o({ref:t},s),{},{components:n})):r.createElement(g,o({ref:t},s))}));function d(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var a=n.length,o=new Array(a);o[0]=m;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var p=2;p<a;p++)o[p]=n[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},98840:function(e,t,n){n.r(t),n.d(t,{assets:function(){return s},contentTitle:function(){return c},default:function(){return d},frontMatter:function(){return l},metadata:function(){return p},toc:function(){return u}});var r=n(87462),i=n(63366),a=(n(67294),n(3905)),o=["components"],l={id:"webgl-interactingwithbrowserscripting",title:"Interaction with browser scripting",slug:"/webgl-develop/webgl-interactingwithbrowserscripting"},c="Interaction with browser scripting",p={unversionedId:"platform-specific/webgl/webgl-develop/webgl-interactingwithbrowserscripting",id:"platform-specific/webgl/webgl-develop/webgl-interactingwithbrowserscripting",title:"Interaction with browser scripting",description:"\u6784\u5efa\u9002\u7528\u4e8e Web \u7684\u5185\u5bb9\u65f6\uff0c\u53ef\u80fd\u9700\u8981\u4e0e\u7f51\u9875\u4e0a\u7684\u5176\u4ed6\u5143\u7d20\u8fdb\u884c\u901a\u4fe1\u3002\u6216\u8005\uff0c\u60a8\u53ef\u80fd\u5e0c\u671b\u4f7f\u7528 Unity \u5f53\u524d\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u672a\u516c\u5f00\u7684 Web API \u6765\u5b9e\u73b0\u529f\u80fd\u3002\u5728\u8fd9\u4e24\u79cd\u60c5\u51b5\u4e0b\uff0c\u90fd\u9700\u8981\u76f4\u63a5\u4e0e\u6d4f\u89c8\u5668\u7684 JavaScript \u5f15\u64ce\u8fde\u63a5\u3002Unity WebGL \u63d0\u4f9b\u4e86\u4e0d\u540c\u7684\u65b9\u6cd5\u6765\u6267\u884c\u6b64\u64cd\u4f5c\u3002",source:"@site/docs/platform-specific/webgl/webgl-develop/webgl-interactingwithbrowserscripting.md",sourceDirName:"platform-specific/webgl/webgl-develop",slug:"/webgl-develop/webgl-interactingwithbrowserscripting",permalink:"/docs/webgl-develop/webgl-interactingwithbrowserscripting",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/platform-specific/webgl/webgl-develop/webgl-interactingwithbrowserscripting.md",tags:[],version:"current",frontMatter:{id:"webgl-interactingwithbrowserscripting",title:"Interaction with browser scripting",slug:"/webgl-develop/webgl-interactingwithbrowserscripting"},sidebar:"tutorialSidebar",previous:{title:"Input in WebGL",permalink:"/docs/webgl-develop/webgl-input"},next:{title:"WebGL \u4e2d\u7684\u5185\u5b58",permalink:"/docs/webgl-develop/webgl-memory"}},s={},u=[{value:"\u4ece Unity \u811a\u672c\u8c03\u7528 JavaScript \u51fd\u6570",id:"\u4ece-unity-\u811a\u672c\u8c03\u7528-javascript-\u51fd\u6570",level:2},{value:"\u4ee3\u7801\u53ef\u89c1\u6027",id:"\u4ee3\u7801\u53ef\u89c1\u6027",level:3},{value:"\u4ece JavaScript \u8c03\u7528 Unity \u811a\u672c\u51fd\u6570",id:"\u4ece-javascript-\u8c03\u7528-unity-\u811a\u672c\u51fd\u6570",level:2},{value:"\u4ece Unity \u811a\u672c\u8c03\u7528 C \u51fd\u6570",id:"\u4ece-unity-\u811a\u672c\u8c03\u7528-c-\u51fd\u6570",level:2}],m={toc:u};function d(e){var t=e.components,n=(0,i.Z)(e,o);return(0,a.kt)("wrapper",(0,r.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"interaction-with-browser-scripting"},"Interaction with browser scripting"),(0,a.kt)("p",null,"\u6784\u5efa\u9002\u7528\u4e8e Web \u7684\u5185\u5bb9\u65f6\uff0c\u53ef\u80fd\u9700\u8981\u4e0e\u7f51\u9875\u4e0a\u7684\u5176\u4ed6\u5143\u7d20\u8fdb\u884c\u901a\u4fe1\u3002\u6216\u8005\uff0c\u60a8\u53ef\u80fd\u5e0c\u671b\u4f7f\u7528 Unity \u5f53\u524d\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u672a\u516c\u5f00\u7684 Web API \u6765\u5b9e\u73b0\u529f\u80fd\u3002\u5728\u8fd9\u4e24\u79cd\u60c5\u51b5\u4e0b\uff0c\u90fd\u9700\u8981\u76f4\u63a5\u4e0e\u6d4f\u89c8\u5668\u7684 JavaScript \u5f15\u64ce\u8fde\u63a5\u3002Unity WebGL \u63d0\u4f9b\u4e86\u4e0d\u540c\u7684\u65b9\u6cd5\u6765\u6267\u884c\u6b64\u64cd\u4f5c\u3002"),(0,a.kt)("h2",{id:"\u4ece-unity-\u811a\u672c\u8c03\u7528-javascript-\u51fd\u6570"},"\u4ece Unity \u811a\u672c\u8c03\u7528 JavaScript \u51fd\u6570"),(0,a.kt)("p",null,"\u5728\u9879\u76ee\u4e2d\u4f7f\u7528\u6d4f\u89c8\u5668 JavaScript \u7684\u5efa\u8bae\u65b9\u6cd5\u662f\u5c06 JavaScript \u6e90\u4ee3\u7801\u6dfb\u52a0\u5230\u9879\u76ee\u4e2d\uff0c\u7136\u540e\u76f4\u63a5\u4ece\u811a\u672c\u4ee3\u7801\u4e2d\u8c03\u7528\u8fd9\u4e9b\u51fd\u6570\u3002\u4e3a\u6b64\uff0c\u8bf7\u4f7f\u7528 .jslib \u6269\u5c55\u540d\u5c06\u5305\u542b JavaScript \u4ee3\u7801\u7684\u6587\u4ef6\u653e\u7f6e\u5728 Assets \u6587\u4ef6\u5939\u4e2d\u7684\u201cPlugins\u201d\u5b50\u6587\u4ef6\u5939\u4e0b\u3002\u63d2\u4ef6\u6587\u4ef6\u9700\u8981\u6709\u5982\u4e0b\u6240\u793a\u7684\u8bed\u6cd5\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'mergeInto(LibraryManager.library, {\n\n  Hello: function () {\n    window.alert("Hello, world!");\n  },\n\n  HelloString: function (str) {\n    window.alert(UTF8ToString(str));\n  },\n\n  PrintFloatArray: function (array, size) {\n    for(var i = 0; i &lt; size; i++)\n    console.log(HEAPF32[(array &gt;&gt; 2) + i]);\n  },\n\n  AddNumbers: function (x, y) {\n    return x + y;\n  },\n\n  StringReturnValueFunction: function () {\n    var returnStr = "bla";\n    var bufferSize = lengthBytesUTF8(returnStr) + 1;\n    var buffer = _malloc(bufferSize);\n    stringToUTF8(returnStr, buffer, bufferSize);\n    return buffer;\n  },\n\n  BindWebGLTexture: function (texture) {\n    GLctx.bindTexture(GLctx.TEXTURE_2D, GL.textures[texture]);\n  },\n\n});\n')),(0,a.kt)("p",null,"\u7136\u540e\uff0c\u53ef\u4ece C# \u811a\u672c\u8c03\u7528\u8fd9\u4e9b\u51fd\u6570\uff0c\u5982\u4e0b\u6240\u793a\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'using UnityEngine;\nusing System.Runtime.InteropServices;\n\npublic class NewBehaviourScript : MonoBehaviour {\n\n    [DllImport("__Internal")]\n    private static extern void Hello();\n\n    [DllImport("__Internal")]\n    private static extern void HelloString(string str);\n\n    [DllImport("__Internal")]\n    private static extern void PrintFloatArray(float[] array, int size);\n\n    [DllImport("__Internal")]\n    private static extern int AddNumbers(int x, int y);\n\n    [DllImport("__Internal")]\n    private static extern string StringReturnValueFunction();\n\n    [DllImport("__Internal")]\n    private static extern void BindWebGLTexture(int texture);\n\n    void Start() {\n        Hello();\n        \n        HelloString("This is a string.");\n        \n        float[] myArray = new float[10];\n        PrintFloatArray(myArray, myArray.Length);\n        \n        int result = AddNumbers(5, 7);\n        Debug.Log(result);\n        \n        Debug.Log(StringReturnValueFunction());\n        \n        var texture = new Texture2D(0, 0, TextureFormat.ARGB32, false);\n        BindWebGLTexture(texture.GetNativeTexturePtr());\n    }\n}\n')),(0,a.kt)("p",null,"Simple numeric types can be passed to JavaScript in function parameters without requiring any conversion. Other data types is passed as a pointer in the emscripten heap (which is just a big array in JavaScript). For strings, you can use the ",(0,a.kt)("inlineCode",{parentName:"p"},"UTF8ToString")," helper function to convert to a JavaScript string. To return a string value you need to call ",(0,a.kt)("inlineCode",{parentName:"p"},"_malloc")," to allocate some memory and the ",(0,a.kt)("inlineCode",{parentName:"p"},"stringToUTF8")," helper function to write a JavaScript string to it. If the string is a return value, then the il2cpp runtime will take care of freeing the memory for you. For arrays of primitive types, ",(0,a.kt)("inlineCode",{parentName:"p"},"emscripten")," provides different ",(0,a.kt)("inlineCode",{parentName:"p"},"ArrayBufferViews")," into it\u2019s heap for different sizes of integer, unsigned integer or floating point representations of memory:  ",(0,a.kt)("strong",{parentName:"p"},"HEAP8, HEAPU8, HEAP16, HEAPU16, HEAP32, HEAPU32, HEAPF32, HEAPF64")," . To access a texture in WebGL, emscripten provides the ",(0,a.kt)("inlineCode",{parentName:"p"},"GL.textures")," array which maps native texture IDs from Unity to WebGL texture objects. WebGL functions can be called on emscripten\u2019s WebGL context, ",(0,a.kt)("inlineCode",{parentName:"p"},"GLctx"),"."),(0,a.kt)("p",null,"\u6709\u5173\u5982\u4f55\u4e0e JavaScript \u4ea4\u4e92\u7684\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605 ",(0,a.kt)("a",{parentName:"p",href:"https://kripken.github.io/emscripten-site/docs/porting/connecting_cpp_and_javascript/Interacting-with-code.html"},"emscripten \u6587\u6863"),"\u3002"),(0,a.kt)("p",null,"\u53e6\u5916\uff0c\u8bf7\u6ce8\u610f\uff0c\u5728 Unity \u5b89\u88c5\u6587\u4ef6\u5939\u4e2d\u6709\u51e0\u4e2a\u63d2\u4ef6\u53ef\u4f9b\u53c2\u8003\uff08\u4f4d\u4e8e ",(0,a.kt)("inlineCode",{parentName:"p"},"PlaybackEngines/WebGLSupport/BuildTools/lib")," \u548c ",(0,a.kt)("inlineCode",{parentName:"p"},"PlaybackEngines/WebGLSupport/BuildTools/Emscripten/src/library*")," \u4e2d\uff09\u3002"),(0,a.kt)("h3",{id:"\u4ee3\u7801\u53ef\u89c1\u6027"},"\u4ee3\u7801\u53ef\u89c1\u6027"),(0,a.kt)("p",null,"Starting from Unity 5.6 all the build code is executed in its own scope. This approach makes it possible to embed your content on an arbitrary page without causing conflicts with the embedding page code, and makes it possible to embed more than one build on the same page."),(0,a.kt)("p",null,"If you have all your JavaScript code in the form of ",(0,a.kt)("em",{parentName:"p"},".jslib")," plugins inside your project, then this JavaScript code will run inside the same scope as the compiled build and your code should work the same way as in previous versions of Unity. For example, the following objects and functions should be directly visible from the JavaScript plugin code: ",(0,a.kt)("em",{parentName:"p"},"Module, SendMessage, HEAP8, ccall etc."),"."),(0,a.kt)("p",null,"\u4f46\u662f\uff0c\u5982\u679c\u8ba1\u5212\u4ece\u5d4c\u5165\u9875\u9762\u7684\u5168\u5c40\u4f5c\u7528\u57df\u8c03\u7528\u5185\u90e8 JavaScript \u51fd\u6570\uff0c\u5219\u5fc5\u987b\u5728 WebGL \u6a21\u677f index.html \u4e2d\u4f7f\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"unityInstance")," \u53d8\u91cf\u3002\u5728 Unity \u5f15\u64ce\u5b9e\u4f8b\u5316\u6210\u529f\u540e\u6267\u884c\u6b64\u64cd\u4f5c\uff0c\u4f8b\u5982\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"  var myGameInstance = null;\n    script.onload = () =&gt; {\n      createUnityInstance(canvas, config, (progress) =&gt; {...}).then((unityInstance) =&gt; {\n        myGameInstance = unityInstance;\n        \u2026\n")),(0,a.kt)("p",null,"\u7136\u540e\u53ef\u4ee5\u4f7f\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"myGameInstance.SendMessage()")," \u5411\u6784\u5efa\u53d1\u9001\u6d88\u606f\uff0c\u6216\u4f7f\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"myGameInstance.Module")," \u8bbf\u95ee\u6784\u5efa Module \u5bf9\u8c61\u3002"),(0,a.kt)("h2",{id:"\u4ece-javascript-\u8c03\u7528-unity-\u811a\u672c\u51fd\u6570"},"\u4ece JavaScript \u8c03\u7528 Unity \u811a\u672c\u51fd\u6570"),(0,a.kt)("p",null,"\u6709\u65f6\u9700\u8981\u4ece\u6d4f\u89c8\u5668\u7684 JavaScript \u5411 Unity \u811a\u672c\u53d1\u9001\u4e00\u4e9b\u6570\u636e\u6216\u901a\u77e5\u3002\u5efa\u8bae\u7684\u505a\u6cd5\u662f\u8c03\u7528\u5185\u5bb9\u4e2d\u7684\u6e38\u620f\u5bf9\u8c61\u4e0a\u7684\u65b9\u6cd5\u3002\u5982\u679c\u8981\u4ece\u5d4c\u5165\u5728\u9879\u76ee\u4e2d\u7684 JavaScript \u63d2\u4ef6\u6267\u884c\u8c03\u7528\uff0c\u53ef\u4f7f\u7528\u4ee5\u4e0b\u4ee3\u7801\uff1a"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"MyGameInstance.SendMessage(objectName, methodName, value);")),(0,a.kt)("p",null,"\u5176\u4e2d\uff0c ",(0,a.kt)("strong",{parentName:"p"},"objectName"),"  \u662f\u573a\u666f\u4e2d\u7684\u5bf9\u8c61\u540d\u79f0\uff1b ",(0,a.kt)("strong",{parentName:"p"},"methodName"),"  \u662f\u5f53\u524d\u9644\u52a0\u5230\u8be5\u5bf9\u8c61\u7684\u811a\u672c\u4e2d\u7684\u65b9\u6cd5\u540d\u79f0\uff1b ",(0,a.kt)("strong",{parentName:"p"},"value"),"  \u53ef\u4ee5\u662f\u5b57\u7b26\u4e32\u3001\u6570\u5b57\uff0c\u4e5f\u53ef\u4e3a\u7a7a\u3002\u4f8b\u5982\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"MyGameInstance.SendMessage('MyGameObject', 'MyFunction');\nMyGameInstance.SendMessage('MyGameObject', 'MyFunction', 5);\n\nMyGameInstance.SendMessage('MyGameObject', 'MyFunction', 'MyString');\n")),(0,a.kt)("p",null,"\u5982\u679c\u5e0c\u671b\u4ece\u5d4c\u5165\u9875\u9762\u7684\u5168\u5c40\u4f5c\u7528\u57df\u5185\u6267\u884c\u8c03\u7528\uff0c\u8bf7\u53c2\u9605\u4e0b\u9762\u7684",(0,a.kt)("em",{parentName:"p"},"\u4ee3\u7801\u53ef\u89c1\u6027"),"\u90e8\u5206\u3002"),(0,a.kt)("h2",{id:"\u4ece-unity-\u811a\u672c\u8c03\u7528-c-\u51fd\u6570"},"\u4ece Unity \u811a\u672c\u8c03\u7528 C \u51fd\u6570"),(0,a.kt)("p",null,"\u7531\u4e8e Unity \u4f7f\u7528 emscripten \u5c06\u6e90\u4ee3\u7801\u4ece C/C++ \u4ee3\u7801\u7f16\u8bd1\u4e3a JavaScript\uff0c\u56e0\u6b64\u60a8\u4e5f\u53ef\u4ee5\u4f7f\u7528 C/C++ \u4ee3\u7801\u7f16\u5199\u63d2\u4ef6\uff0c\u5e76\u4ece C# \u8c03\u7528\u8fd9\u4e9b\u51fd\u6570\u3002\u56e0\u6b64\uff0c\u60a8\u53ef\u4ee5\u4e0d\u4f7f\u7528\u4e0a\u9762\u793a\u4f8b\u4e2d\u7684 jslib \u6587\u4ef6\uff0c\u800c\u662f\u5728\u9879\u76ee\u4e2d\u4f7f\u7528 C/C++ \u6587\u4ef6\uff1b\u5b83\u5c06\u81ea\u52a8\u4f7f\u7528\u60a8\u7684\u811a\u672c\u5b9e\u73b0\u7f16\u8bd1\uff0c\u5e76\u4e14\u60a8\u53ef\u4ee5\u4ece\u4e2d\u8c03\u7528\u51fd\u6570\uff0c\u5c31\u50cf\u4e0a\u9762\u7684 JavaScript \u793a\u4f8b\u4e00\u6837\u3002"),(0,a.kt)("p",null,"\u5982\u679c\u4f7f\u7528 C++ (.cpp) \u6765\u5b9e\u73b0\u8be5\u63d2\u4ef6\uff0c\u5219\u5fc5\u987b\u786e\u4fdd\u4f7f\u7528 C \u94fe\u63a5\u6765\u58f0\u660e\u51fd\u6570\u4ee5\u514d\u53d1\u751f\u540d\u79f0\u9519\u7528\u95ee\u9898\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'# include &lt;stdio.h&gt;\n\nextern "C" void Hello ()\n{\n    printf("Hello, world!\\n");\n}\n\nextern "C" int AddNumbers (int x, int y)\n{\n    return x + y;\n}\n')),(0,a.kt)("hr",null),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"replaced Pointer**stringify() with UTF8ToString in 2021.2 onwards"),(0,a.kt)("li",{parentName:"ul"},"\u5728 2020.1 \u4e2d unity.Instance \u5df2\u66ff\u6362\u4e3a createUnityInstance"),(0,a.kt)("li",{parentName:"ul"},"\u4fee\u590d\u4e86\u4ee3\u7801\u793a\u4f8b\u4e2d\u7684\u9519\u8bef\u3002"),(0,a.kt)("li",{parentName:"ul"},"\u5728 2019.1\u4e2d\uff0cWebGL \u5b9e\u4f8b gameInstance \u66f4\u540d\u4e3a unityInstance")))}d.isMDXComponent=!0}}]);