"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[48659],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return u}});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),m=c(n),u=r,d=m["".concat(l,".").concat(u)]||m[u]||h[u]||i;return n?a.createElement(d,s(s({ref:t},p),{},{components:n})):a.createElement(d,s({ref:t},p))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,s=new Array(i);s[0]=m;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:r,s[1]=o;for(var c=2;c<i;c++)s[c]=n[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},33022:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return l},default:function(){return u},frontMatter:function(){return o},metadata:function(){return c},toc:function(){return h}});var a=n(87462),r=n(63366),i=(n(67294),n(3905)),s=["components"],o={id:"GPUInstancing",title:"GPU \u5b9e\u4f8b\u5316",slug:"/gpuinstancing"},l="GPU \u5b9e\u4f8b\u5316",c={unversionedId:"graphics/graphics-performance-profiling/optimizing-draw-calls/gpuinstancing/GPUInstancing",id:"graphics/graphics-performance-profiling/optimizing-draw-calls/gpuinstancing/GPUInstancing",title:"GPU \u5b9e\u4f8b\u5316",description:"GPU instancing is a draw call optimization method that renders multiple copies of a mesh with the same material in a single draw call. Each copy of the mesh is called an instance. This is useful for drawing things that appear multiple times in a scene, for example, trees or bushes.",source:"@site/docs/graphics/graphics-performance-profiling/optimizing-draw-calls/gpuinstancing/gpuinstancing.md",sourceDirName:"graphics/graphics-performance-profiling/optimizing-draw-calls/gpuinstancing",slug:"/gpuinstancing",permalink:"/docs/gpuinstancing",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/graphics/graphics-performance-profiling/optimizing-draw-calls/gpuinstancing/gpuinstancing.md",tags:[],version:"current",frontMatter:{id:"GPUInstancing",title:"GPU \u5b9e\u4f8b\u5316",slug:"/gpuinstancing"},sidebar:"tutorialSidebar",previous:{title:"Static batching",permalink:"/docs/draw-call-batching/static-batching"},next:{title:"Creating shaders that support GPU instancing",permalink:"/docs/gpuinstancing/gpu-instancing-shader"}},p={},h=[{value:"Requirements and compatibility",id:"requirements-and-compatibility",level:2},{value:"Platform compatibility",id:"platform-compatibility",level:3},{value:"Render pipeline compatibility",id:"render-pipeline-compatibility",level:3},{value:"SRP Batcher",id:"srp-batcher",level:3},{value:"Using GPU instancing",id:"using-gpu-instancing",level:2},{value:"Lighting",id:"lighting",level:3},{value:"Performance implications",id:"performance-implications",level:2}],m={toc:h};function u(e){var t=e.components,n=(0,r.Z)(e,s);return(0,i.kt)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"gpu-\u5b9e\u4f8b\u5316"},"GPU \u5b9e\u4f8b\u5316"),(0,i.kt)("p",null,"GPU instancing is a ",(0,i.kt)("a",{parentName:"p",href:"/docs/optimizing-draw-calls"},"draw call optimization")," method that renders multiple copies of a mesh with the same material in a single draw call. Each copy of the mesh is called an instance. This is useful for drawing things that appear multiple times in a scene, for example, trees or bushes."),(0,i.kt)("p",null,"GPU instancing renders identical meshes in the same draw call. To add variation and reduce the appearance of repetition, each instance can have different properties, such as  ",(0,i.kt)("strong",{parentName:"p"},"Color"),"  or  ",(0,i.kt)("strong",{parentName:"p"},"Scale")," . Draw calls that render multiple instances appear in the ",(0,i.kt)("a",{parentName:"p",href:"/docs/graphics-performance-profiling/frame-debugger"},"Frame Debugger")," as  ",(0,i.kt)("strong",{parentName:"p"},"Draw Mesh (instanced)")," ."),(0,i.kt)("h2",{id:"requirements-and-compatibility"},"Requirements and compatibility"),(0,i.kt)("p",null,"This section includes information about the platform, render pipeline, and SRP Batcher compatibility of GPU instancing."),(0,i.kt)("h3",{id:"platform-compatibility"},"Platform compatibility"),(0,i.kt)("p",null,"GPU instancing is available on every platform except WebGL 1.0."),(0,i.kt)("h3",{id:"render-pipeline-compatibility"},"Render pipeline compatibility"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},(0,i.kt)("strong",{parentName:"th"},"\u529f\u80fd")),(0,i.kt)("th",{parentName:"tr",align:null},(0,i.kt)("strong",{parentName:"th"},"\u5185\u7f6e\u6e32\u67d3\u7ba1\u7ebf")),(0,i.kt)("th",{parentName:"tr",align:null},(0,i.kt)("strong",{parentName:"th"},"\u901a\u7528\u6e32\u67d3\u7ba1\u7ebf (URP)")),(0,i.kt)("th",{parentName:"tr",align:null},(0,i.kt)("strong",{parentName:"th"},"\u9ad8\u6e05\u6e32\u67d3\u7ba1\u7ebf (HDRP)")),(0,i.kt)("th",{parentName:"tr",align:null},(0,i.kt)("strong",{parentName:"th"},"Custom Scriptable Render Pipeline (SRP)")))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("strong",{parentName:"td"},"GPU instancing")),(0,i.kt)("td",{parentName:"tr",align:null},"\u662f"),(0,i.kt)("td",{parentName:"tr",align:null},"\u662f (1)"),(0,i.kt)("td",{parentName:"tr",align:null},"\u662f (1)"),(0,i.kt)("td",{parentName:"tr",align:null},"\u662f (1)")))),(0,i.kt)("p",null," ",(0,i.kt)("strong",{parentName:"p"},"\u6ce8\u610f")," \uff1a"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Only if the shader isn\u2019t compatible with the ",(0,i.kt)("a",{parentName:"li",href:"/docs/optimizing-draw-calls/srpbatcher"},"SRP Batcher"),".")),(0,i.kt)("h3",{id:"srp-batcher"},"SRP Batcher"),(0,i.kt)("p",null,"GPU instancing isn\u2019t compatible with the ",(0,i.kt)("a",{parentName:"p",href:"/docs/optimizing-draw-calls/srpbatcher"},"SRP Batcher"),". The SRP Batcher takes priority over GPU instancing. If a GameObject is compatible with the SRP Batcher, Unity uses the SRP Batcher to render it, not GPU instancing. For more information about optimization method priority, see ",(0,i.kt)("a",{parentName:"p",href:"/docs/optimizing-draw-calls#optimization-priority"},"Optimization priority"),"."),(0,i.kt)("p",null,"If your project uses the SRP Batcher and you want to use GPU instancing for a GameObject, you can do one of the following:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Use ",(0,i.kt)("a",{parentName:"li",href:"https://docs.unity3d.com/cn/2022.1/ScriptReference/Graphics.DrawMeshInstanced.html"},"Graphics.DrawMeshInstanced"),". This API bypasses the use of GameObjects and uses the specified parameters to directly draw a mesh on screen."),(0,i.kt)("li",{parentName:"ul"},"Manually remove SRP Batcher compatibility. For information on how to do this, see ",(0,i.kt)("a",{parentName:"li",href:"/docs/optimizing-draw-calls/srpbatcher#intentionally-removing-srp-batcher-compatibility-for-game-objects"},"Intentionally removing compatibility"),".")),(0,i.kt)("h2",{id:"using-gpu-instancing"},"Using GPU instancing"),(0,i.kt)("p",null,"Unity uses GPU instancing for GameObjects that share the same mesh and material. To instance a mesh and material:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The material\u2019s ",(0,i.kt)("a",{parentName:"li",href:"/docs/shaders"},"shader")," must support GPU instancing. Unity\u2019s ",(0,i.kt)("a",{parentName:"li",href:"/docs/shader-standard-shader"},"Standard Shader")," supports GPU instancing, as do all ",(0,i.kt)("a",{parentName:"li",href:"/docs/sl-surface-shaders"},"surface shaders"),". To add GPU instancing support to any other shader, see ","[","Creating shaders that support GPU instancing(gpu-instancing-shader)."),(0,i.kt)("li",{parentName:"ul"},"The mesh must be from one of the following sources:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"A ",(0,i.kt)("a",{parentName:"li",href:"/docs/comp-mesh-group/class-mesh-renderer"},"MeshRenderer")," component or a ",(0,i.kt)("a",{parentName:"li",href:"https://docs.unity3d.com/cn/2022.1/ScriptReference/Graphics.DrawMesh.html"},"Graphics.DrawMesh")," call. Unity adds meshes from these sources to a list and attempts to instance them together. If the GameObject that a MeshRenderer component is attached to is SRP Batcher compatible, then Unity can\u2019t instance that mesh. For more information, see ",(0,i.kt)("a",{parentName:"li",href:"#srp-batcher"},"SRP Batcher compatibility"),". ",(0,i.kt)("br",null)," ",(0,i.kt)("strong",{parentName:"li"},"Note")," : Unity doesn\u2019t support GPU instancing for ",(0,i.kt)("a",{parentName:"li",href:"/docs/comp-mesh-group/class-skinned-mesh-renderer"},"SkinnedMeshRenderers"),"."),(0,i.kt)("li",{parentName:"ul"},"A ",(0,i.kt)("a",{parentName:"li",href:"https://docs.unity3d.com/cn/2022.1/ScriptReference/Graphics.DrawMeshInstanced.html"},"Graphics.DrawMeshInstanced")," or ",(0,i.kt)("a",{parentName:"li",href:"https://docs.unity3d.com/cn/2022.1/ScriptReference/Graphics.DrawMeshInstancedIndirect.html"},"Graphics.DrawMeshInstancedIndirect")," call. These methods instance the same mesh in multiple places using the same shader. Unity executes each call separately which means it can\u2019t instance meshes from different calls together.")))),(0,i.kt)("p",null,"To use GPU instancing for a material, select the  ",(0,i.kt)("strong",{parentName:"p"},"Enable GPU Instancing"),"  option in the Inspector."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://docs.unity3d.com/cn/2022.1/uploads/Main/enable-gpu-instancing-inspector.png",alt:"The Enable GPU Instancing option as it appears in the material Inspector."})),(0,i.kt)("p",null,"The Enable GPU Instancing option as it appears in the material Inspector."),(0,i.kt)("h3",{id:"lighting"},"Lighting"),(0,i.kt)("p",null,"GPU instancing supports Unity\u2019s ",(0,i.kt)("a",{parentName:"p",href:"/docs/lightmappers/gi-enlighten"},"Baked Global Illumination system"),". Unity Standard Shaders and surface shaders support GPU instancing and Unity\u2019s Baked Global Illumination system by default."),(0,i.kt)("p",null,"Each GPU instance supports global illumination from one of the following sources:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Any number of ",(0,i.kt)("a",{parentName:"li",href:"/docs/light-probes"},"Light Probes"),"."),(0,i.kt)("li",{parentName:"ul"},"One ",(0,i.kt)("a",{parentName:"li",href:"/docs/lightmappers/lightmapping"},"lightmap"),". ",(0,i.kt)("br",null)," ",(0,i.kt)("strong",{parentName:"li"},"Note")," : An instance can use multiple atlas regions in the lightmap."),(0,i.kt)("li",{parentName:"ul"},"One ",(0,i.kt)("a",{parentName:"li",href:"/docs/light-probes/class-light-probe-proxy-volume"},"Light Probe Proxy Volume"),"(LPPV) component. ",(0,i.kt)("br",null)," ",(0,i.kt)("strong",{parentName:"li"},"Note")," : You must bake the LPPV for the space volume that contains all the instances.")),(0,i.kt)("p",null,"GPU instancing automatically works with:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Dynamic ",(0,i.kt)("a",{parentName:"li",href:"/docs/comp-mesh-group/class-mesh-renderer"},"Mesh Renderers")," affected by Light Probes."),(0,i.kt)("li",{parentName:"ul"},"Static Mesh Renderers you bake to the same lightmap texture. A Mesh Renderer is static in this context if it includes  ",(0,i.kt)("strong",{parentName:"li"},"Contribute GI"),"  in its ",(0,i.kt)("a",{parentName:"li",href:"/docs/game-objects/static-objects"},"Static Editor Flags"),".")),(0,i.kt)("p",null,"To enable Light Probe rendering for ",(0,i.kt)("inlineCode",{parentName:"p"},"Graphics.DrawMeshInstanced"),", set the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.unity3d.com/cn/2022.1/ScriptReference/Rendering.LightProbeUsage.html"},"LightProbeUsage")," parameter to ",(0,i.kt)("a",{parentName:"p",href:"https://docs.unity3d.com/cn/2022.1/ScriptReference/Rendering.LightProbeUsage.CustomProvided.html"},"CustomProvided")," and provide a ",(0,i.kt)("a",{parentName:"p",href:"https://docs.unity3d.com/cn/2022.1/ScriptReference/MaterialPropertyBlock.html"},"MaterialPropertyBlock")," that includes the Probe data. For more information and code examples, see ",(0,i.kt)("a",{parentName:"p",href:"https://docs.unity3d.com/cn/2022.1/ScriptReference/LightProbes.CalculateInterpolatedLightAndOcclusionProbes.html"},"LightProbes.CalculateInterpolatedLightAndOcclusionProbes"),"."),(0,i.kt)("p",null,"Alternatively, you can pass an LPPV component reference and ",(0,i.kt)("a",{parentName:"p",href:"https://docs.unity3d.com/cn/2022.1/ScriptReference/Rendering.LightProbeUsage.UseProxyVolume.html"},"LightProbeUsage.UseProxyVolume")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"Graphics.DrawMeshInstanced"),". When you do this, all instances sample the volume for the ",(0,i.kt)("a",{parentName:"p",href:"/docs/light-probes/light-probes-technical-information"},"L0 and L1 bands")," of the Light Probe data. If you want to supplement L2 data and occlusion data, use a ",(0,i.kt)("inlineCode",{parentName:"p"},"MaterialPropertyBlock"),". For more information, see ",(0,i.kt)("a",{parentName:"p",href:"/docs/light-probes/light-probes-technical-information"},"Light Probes: Technical Information"),"."),(0,i.kt)("h2",{id:"performance-implications"},"Performance implications"),(0,i.kt)("p",null,"Meshes that have a low number of vertices can\u2019t be processed efficiently using GPU instancing because the GPU can\u2019t distribute the work in a way that fully uses the GPU\u2019s resources. This processing inefficiency can have a detrimental effect on performance. The threshold at which inefficiencies begin depends on the GPU, but as a general rule, don\u2019t use GPU instancing for meshes that have fewer than 256 vertices."),(0,i.kt)("p",null,"If you want to render a mesh with a low number of vertices many times, best practice is to create a single buffer that contains all the mesh information and use that to draw the meshes."),(0,i.kt)("hr",null),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"2017\u201310\u201324 \u9875\u9762\u5df2\u4fee\u8ba2"),(0,i.kt)("li",{parentName:"ul"},"\u5728 5.6 \u7248\u4e2d\u589e\u52a0\u4e86 Enable Instancing \u590d\u9009\u6846\u6307\u5357\u3001DrawMeshInstancedIndirect \u548c #pragma multi-compile"),(0,i.kt)("li",{parentName:"ul"},"\u5728 ",(0,i.kt)("a",{parentName:"li",href:"https://docs.unity3d.com/2017.3/Documentation/Manual/30_search.html?q=newin20173"},"2017.3")," \u7248\u4e2d\u589e\u52a0\u4e86\u9488\u5bf9 GPU \u5b9e\u4f8b\u5316\u7684\u7740\u8272\u5668\u9884\u70ed NewIn20173"),(0,i.kt)("li",{parentName:"ul"},"\u5728 ",(0,i.kt)("a",{parentName:"li",href:"https://docs.unity3d.com/2018.1/Documentation/Manual/30_search.html?q=newin20181"},"2018.1")," \u7248\u4e2d\u589e\u52a0\u4e86 GPU \u5b9e\u4f8b\u5316\u7684\u5168\u5c40\u5149\u7167 (GI) \u652f\u6301 NewIn20181")))}u.isMDXComponent=!0}}]);