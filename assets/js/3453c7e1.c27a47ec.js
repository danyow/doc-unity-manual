"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[88714],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return b}});var o=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=o.createContext({}),c=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return o.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},u=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=c(n),b=a,m=u["".concat(s,".").concat(b)]||u[b]||d[b]||r;return n?o.createElement(m,i(i({ref:t},p),{},{components:n})):o.createElement(m,i({ref:t},p))}));function b(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,i=new Array(r);i[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,i[1]=l;for(var c=2;c<r;c++)i[c]=n[c];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}u.displayName="MDXCreateElement"},60430:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return s},default:function(){return b},frontMatter:function(){return l},metadata:function(){return c},toc:function(){return d}});var o=n(87462),a=n(63366),r=(n(67294),n(3905)),i=["components"],l={id:"JobSystemJobDependencies",title:"JobHandle \u548c\u4f9d\u8d56\u9879",slug:"/job-system/job-system-job-dependencies"},s="JobHandle \u548c\u4f9d\u8d56\u9879",c={unversionedId:"scripting-section/job-system/JobSystemJobDependencies",id:"scripting-section/job-system/JobSystemJobDependencies",title:"JobHandle \u548c\u4f9d\u8d56\u9879",description:"\u8c03\u7528\u4f5c\u4e1a\u7684 Schedule \u65b9\u6cd5\u65f6\uff0c\u5c06\u8fd4\u56de JobHandle\u3002\u53ef\u4ee5\u5728\u4ee3\u7801\u4e2d\u4f7f\u7528 JobHandle \u4f5c\u4e3a\u5176\u4ed6\u4f5c\u4e1a\u7684\u4f9d\u8d56\u9879\u3002\u5982\u679c\u4e00\u4e2a\u4f5c\u4e1a\u4f9d\u8d56\u4e8e\u53e6\u4e00\u4e2a\u4f5c\u4e1a\u7684\u7ed3\u679c\uff0c\u5219\u53ef\u4ee5\u5c06\u7b2c\u4e00\u4e2a\u4f5c\u4e1a\u7684 JobHandle \u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\u7ed9\u7b2c\u4e8c\u4e2a\u4f5c\u4e1a\u7684 Schedule \u65b9\u6cd5\uff0c\u5982\u4e0b\u6240\u793a\uff1a",source:"@site/docs/scripting-section/job-system/job-system-job-dependencies.md",sourceDirName:"scripting-section/job-system",slug:"/job-system/job-system-job-dependencies",permalink:"/docs/job-system/job-system-job-dependencies",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/scripting-section/job-system/job-system-job-dependencies.md",tags:[],version:"current",frontMatter:{id:"JobSystemJobDependencies",title:"JobHandle \u548c\u4f9d\u8d56\u9879",slug:"/job-system/job-system-job-dependencies"},sidebar:"tutorialSidebar",previous:{title:"\u521b\u5efa\u4f5c\u4e1a",permalink:"/docs/job-system/job-system-creating-jobs"},next:{title:"\u4ec0\u4e48\u662f\u4f5c\u4e1a\u7cfb\u7edf\uff1f",permalink:"/docs/job-system/job-system-job-systems"}},p={},d=[{value:"\u5408\u5e76\u4f9d\u8d56\u9879",id:"\u5408\u5e76\u4f9d\u8d56\u9879",level:2},{value:"Waiting for jobs in the control thread",id:"waiting-for-jobs-in-the-control-thread",level:2},{value:"\u591a\u4e2a\u4f5c\u4e1a\u548c\u4f9d\u8d56\u9879\u7684\u793a\u4f8b",id:"\u591a\u4e2a\u4f5c\u4e1a\u548c\u4f9d\u8d56\u9879\u7684\u793a\u4f8b",level:2}],u={toc:d};function b(e){var t=e.components,n=(0,a.Z)(e,i);return(0,r.kt)("wrapper",(0,o.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"jobhandle-\u548c\u4f9d\u8d56\u9879"},"JobHandle \u548c\u4f9d\u8d56\u9879"),(0,r.kt)("p",null,"\u8c03\u7528\u4f5c\u4e1a\u7684 ",(0,r.kt)("a",{parentName:"p",href:"https://docs.unity3d.com/cn/2022.1/ScriptReference/Unity.Jobs.IJobExtensions.Schedule.html"},"Schedule")," \u65b9\u6cd5\u65f6\uff0c\u5c06\u8fd4\u56de ",(0,r.kt)("a",{parentName:"p",href:"https://docs.unity3d.com/cn/2022.1/ScriptReference/Unity.Jobs.JobHandle.html"},"JobHandle"),"\u3002\u53ef\u4ee5\u5728\u4ee3\u7801\u4e2d\u4f7f\u7528 ",(0,r.kt)("inlineCode",{parentName:"p"},"JobHandle")," \u4f5c\u4e3a\u5176\u4ed6\u4f5c\u4e1a\u7684\u4f9d\u8d56\u9879\u3002\u5982\u679c\u4e00\u4e2a\u4f5c\u4e1a\u4f9d\u8d56\u4e8e\u53e6\u4e00\u4e2a\u4f5c\u4e1a\u7684\u7ed3\u679c\uff0c\u5219\u53ef\u4ee5\u5c06\u7b2c\u4e00\u4e2a\u4f5c\u4e1a\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"JobHandle")," \u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\u7ed9\u7b2c\u4e8c\u4e2a\u4f5c\u4e1a\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"Schedule")," \u65b9\u6cd5\uff0c\u5982\u4e0b\u6240\u793a\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"JobHandle firstJobHandle = firstJob.Schedule();\nsecondJob.Schedule(firstJobHandle);\n")),(0,r.kt)("p",null," ",(0,r.kt)("strong",{parentName:"p"},"Note")," : All of a job\u2019s dependencies must be scheduled on the same control thread as the job itself."),(0,r.kt)("h2",{id:"\u5408\u5e76\u4f9d\u8d56\u9879"},"\u5408\u5e76\u4f9d\u8d56\u9879"),(0,r.kt)("p",null,"\u5982\u679c\u4e00\u4e2a\u4f5c\u4e1a\u5177\u6709\u8bb8\u591a\u4f9d\u8d56\u9879\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528 ",(0,r.kt)("a",{parentName:"p",href:"https://docs.unity3d.com/cn/2022.1/ScriptReference/Unity.Jobs.JobHandle.CombineDependencies.html"},"JobHandle.CombineDependencies")," \u65b9\u6cd5\u5408\u5e76\u8fd9\u4e9b\u4f9d\u8d56\u9879\u3002",(0,r.kt)("inlineCode",{parentName:"p"},"CombineDependencies")," \u53ef\u4ee5\u5c06\u4f9d\u8d56\u9879\u4f20\u9012\u7ed9 ",(0,r.kt)("inlineCode",{parentName:"p"},"Schedule")," \u65b9\u6cd5\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"NativeArray&lt;JobHandle&gt; handles = new NativeArray&lt;JobHandle&gt;(numJobs, Allocator.TempJob);\n\n// \u4f7f\u7528\u6765\u81ea\u591a\u4e2a\u8c03\u5ea6\u4f5c\u4e1a\u7684 `JobHandles` \u586b\u5145 `handles`...\n\nJobHandle jh = JobHandle.CombineDependencies(handles);\n")),(0,r.kt)("h2",{id:"waiting-for-jobs-in-the-control-thread"},"Waiting for jobs in the control thread"),(0,r.kt)("p",null,"Use ",(0,r.kt)("inlineCode",{parentName:"p"},"JobHandle")," to force your code to wait in the control thread for your job to finish executing. To do this, call the method ",(0,r.kt)("a",{parentName:"p",href:"https://docs.unity3d.com/cn/2022.1/ScriptReference/Unity.Jobs.JobHandle.Complete.html"},"Complete")," on the ",(0,r.kt)("inlineCode",{parentName:"p"},"JobHandle"),". At this point, you know the control thread can safely access the ",(0,r.kt)("a",{parentName:"p",href:"https://docs.unity3d.com/cn/2022.1/ScriptReference/Unity.Collections.LowLevel.Unsafe.NativeContainerAttribute.html"},"NativeContainer")," that the job was using."),(0,r.kt)("p",null," ",(0,r.kt)("strong",{parentName:"p"},"Note")," : Jobs do not start executing when you schedule them. If you are waiting for the job in the control thread, and you need access to the NativeContainer data that the job is using, you can call the method ",(0,r.kt)("inlineCode",{parentName:"p"},"JobHandle.Complete"),". This method flushes the jobs from the memory cache and starts the process of execution. Calling ",(0,r.kt)("inlineCode",{parentName:"p"},"Complete")," on a ",(0,r.kt)("inlineCode",{parentName:"p"},"JobHandle")," returns ownership of that job\u2019s ",(0,r.kt)("inlineCode",{parentName:"p"},"NativeContainer")," types to the control thread. You need to call ",(0,r.kt)("inlineCode",{parentName:"p"},"Complete")," on a ",(0,r.kt)("inlineCode",{parentName:"p"},"JobHandle")," to safely access those ",(0,r.kt)("inlineCode",{parentName:"p"},"NativeContainer")," types from the control thread again. It is also possible to return ownership to the control thread by calling ",(0,r.kt)("inlineCode",{parentName:"p"},"Complete")," on a ",(0,r.kt)("inlineCode",{parentName:"p"},"JobHandle")," that is from a job dependency. For example, you can call ",(0,r.kt)("inlineCode",{parentName:"p"},"Complete")," on ",(0,r.kt)("inlineCode",{parentName:"p"},"jobA"),", or you can call ",(0,r.kt)("inlineCode",{parentName:"p"},"Complete")," on ",(0,r.kt)("inlineCode",{parentName:"p"},"jobB")," which depends on ",(0,r.kt)("inlineCode",{parentName:"p"},"jobA"),". Both result in the ",(0,r.kt)("inlineCode",{parentName:"p"},"NativeContainer")," types that are used by ",(0,r.kt)("inlineCode",{parentName:"p"},"jobA")," being safe to access on the control thread after the call to ",(0,r.kt)("inlineCode",{parentName:"p"},"Complete"),"."),(0,r.kt)("p",null,"\u5426\u5219\uff0c\u5982\u679c\u60a8\u4e0d\u9700\u8981\u8bbf\u95ee\u6570\u636e\uff0c\u5219\u9700\u8981\u663e\u5f0f\u5237\u65b0\u6279\u6b21\u3002\u4e3a\u6b64\uff0c\u8bf7\u8c03\u7528\u9759\u6001\u65b9\u6cd5 ",(0,r.kt)("a",{parentName:"p",href:"https://docs.unity3d.com/cn/2022.1/ScriptReference/Unity.Jobs.JobHandle.ScheduleBatchedJobs.html"},"JobHandle.ScheduleBatchedJobs"),"\u3002\u8bf7\u6ce8\u610f\uff0c\u8c03\u7528\u6b64\u65b9\u6cd5\u4f1a\u5bf9\u6027\u80fd\u4ea7\u751f\u8d1f\u9762\u5f71\u54cd\u3002"),(0,r.kt)("h2",{id:"\u591a\u4e2a\u4f5c\u4e1a\u548c\u4f9d\u8d56\u9879\u7684\u793a\u4f8b"},"\u591a\u4e2a\u4f5c\u4e1a\u548c\u4f9d\u8d56\u9879\u7684\u793a\u4f8b"),(0,r.kt)("p",null," ",(0,r.kt)("strong",{parentName:"p"},"\u4f5c\u4e1a\u4ee3\u7801")," \uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"// \u5c06\u4e24\u4e2a\u6d6e\u70b9\u503c\u76f8\u52a0\u7684\u4f5c\u4e1a\npublic struct MyJob : IJob\n{\n    public float a;\n    public float b;\n    public NativeArray&lt;float&gt; result;\n\n    public void Execute()\n    {\n        result[0] = a + b;\n    }\n}\n\n// \u5c06\u4e00\u4e2a\u503c\u52a0\u4e00\u7684\u4f5c\u4e1a\npublic struct AddOneJob : IJob\n{\n    public NativeArray&lt;float&gt; result;\n    \n    public void Execute()\n    {\n        result[0] = result[0] + 1;\n    }\n}\n")),(0,r.kt)("p",null," ",(0,r.kt)("strong",{parentName:"p"},"\u4e3b\u7ebf\u7a0b\u4ee3\u7801")," \uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'// \u521b\u5efa\u5355\u4e2a\u6d6e\u70b9\u6570\u7684\u672c\u673a\u6570\u7ec4\u4ee5\u5b58\u50a8\u7ed3\u679c\u3002\u6b64\u793a\u4f8b\u7b49\u5f85\u4f5c\u4e1a\u5b8c\u6210\nNativeArray&lt;float&gt; result = new NativeArray&lt;float&gt;(1, Allocator.TempJob);\n\n// \u8bbe\u7f6e\u4f5c\u4e1a #1 \u7684\u6570\u636e\nMyJob jobData = new MyJob();\njobData.a = 10;\njobData.b = 10;\njobData.result = result;\n\n// \u8c03\u5ea6\u4f5c\u4e1a #1\nJobHandle firstHandle = jobData.Schedule();\n\n// \u8bbe\u7f6e\u4f5c\u4e1a #2 \u7684\u6570\u636e\nAddOneJob incJobData = new AddOneJob();\nincJobData.result = result;\n\n// \u8c03\u5ea6\u4f5c\u4e1a #2\nJobHandle secondHandle = incJobData.Schedule(firstHandle);\n\n// \u7b49\u5f85\u4f5c\u4e1a #2 \u5b8c\u6210\nsecondHandle.Complete();\n\n// NativeArray \u7684\u6240\u6709\u526f\u672c\u90fd\u6307\u5411\u540c\u4e00\u5185\u5b58\uff0c\u60a8\u53ef\u4ee5\u5728"\u60a8\u7684"NativeArray \u526f\u672c\u4e2d\u8bbf\u95ee\u7ed3\u679c\nfloat aPlusB = result[0];\n\n// \u91ca\u653e\u7531\u7ed3\u679c\u6570\u7ec4\u5206\u914d\u7684\u5185\u5b58\nresult.Dispose();\n')),(0,r.kt)("hr",null),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"2018\u201306\u201315 \u9875\u9762\u5df2\u53d1\u5e03"),(0,r.kt)("li",{parentName:"ul"},"\u5728 ",(0,r.kt)("a",{parentName:"li",href:"https://docs.unity3d.com/2018.1/Documentation/Manual/30_search.html?q=newin20181"},"2018.1")," \u7248\u4e2d\u516c\u5f00\u4e86 C# \u4f5c\u4e1a\u7cfb\u7edf NewIn20181")))}b.isMDXComponent=!0}}]);